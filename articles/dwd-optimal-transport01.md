---
title: "æœ€é©è¼¸é€ã«ã¤ã„ã¦è€ƒãˆã‚‹ (1) â€” ä½•ã‚‚åˆ†ã‹ã‚‰ãªã„ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã‚‹"
emoji: "ğŸ“ˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["æ©Ÿæ¢°å­¦ç¿’", "Python", "ãƒã‚¨ãƒ "]
published: false
---

# ç›®çš„

æœ€é©è¼¸é€ãŒåˆ†ã‹ã‚‰ãªã„ã€‚æœ€é©è¼¸é€è·é›¢ãŒåˆ†ã‹ã‚‰ãªã„ã€‚Earth Mover's Distance ãŒåˆ†ã‹ã‚‰ãªã„ã€‚Wasserstein è·é›¢ãŒåˆ†ã‹ã‚‰ãªã„ã€‚åˆ†ã‹ã‚‰ãªã„æ™‚ã¯å®Ÿé¨“ã—ãªãŒã‚‰ãã‚Œã£ã½ã„ã‚‚ã®ã‚’æ¢ã‚‹ã®ãŒè‰¯ã„æ°—ãŒã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã€è©¦è¡ŒéŒ¯èª¤ã—ã¦ã¿ã‚‹ã€‚

ãªãŠã€å³å¯†ã«ã¯ã“ã‚Œã‚‰ã¯ç´°ã‹ã„åŒºåˆ¥ãŒã‚ã‚‹ã‚ˆã†ã ãŒã€ä»Šå›ã¯ç‰¹ã«åŒºåˆ¥ã›ãšã«æ··åŒã—ã¦ç”¨ã„ã‚‹ã€‚

# äº‹ã®èµ·ã“ã‚Šï¼ˆãƒã‚¨ãƒ ï¼‰

ç‰¹ã«ä½•ã¨ã„ã†ã‚ã‘ã§ã¯ãªã„ãŒã€ãŸã¾ã«æœ€é©è¼¸é€è·é›¢ã¨ã„ã†ã®ã‚’èãã®ã§ã€é©å½“ã«æ¤œç´¢ã—ãŸã‚‰ [æœ€é©è¼¸é€å…¥é–€](https://speakerdeck.com/joisino/zui-shi-shu-song-ru-men) ãŒã‚ã£ã¦ã€3 å‘¨ãã‚‰ã„èª­ã‚“ã ãŒä½•ã‚‚åˆ†ã‹ã‚‰ãªã‹ã£ãŸãƒ»ãƒ»ãƒ»ã€‚ç–‘å•ã¯å˜ç´”ã§ã€

- ç‰‡æ–¹ã®åˆ†å¸ƒä¸Šã®ç‚¹ã‚’ä»–æ–¹ã®åˆ†å¸ƒä¸Šã®ç‚¹ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã®ã£ã¦ã©ã†ã™ã‚‹ã®ï¼Ÿå‰æçŸ¥è­˜ã¨ã—ã¦ä¸ãˆã‚‹ã‚ã‘ã§ã¯ãªã•ãã†ã ãŒãƒ»ãƒ»ãƒ»

ã¨ã„ã†ã“ã¨ã«å°½ãã‚ˆã†ã€‚ãƒšãƒ¼ã‚¸ã‚’ã‚ãã‚‹ã¨ã€è¡Œåˆ—ãŒå‡ºã¦æ¥ã¦ã€æœ€é©åŒ–å•é¡ŒãŒå‡ºã¦æ¥ã¦ã€ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ãŒå‡ºã¦ããŸã®ã§ã€ç„¡ç†ã«ãªã£ãŸğŸ¤¯ğŸ˜µâ€ğŸ’«ğŸ˜µğŸ’«

å‚è€ƒæ–‡çŒ®ã¨ã—ã¦ arXiv:1506.05439 [Learning with a Wasserstein Loss](https://arxiv.org/abs/1506.05439) ãŒã‚ãŒã£ã¦ã„ãŸã®ã§è¦‹ãŸã€‚Eq. (2) ãŒãã‚Œã£ã½ã„:

$$
\begin{align*}
W_c (\mu_1, \mu_2) = \inf_{\gamma \in \prod (\mu_1, \mu_2)} \int_{\mathcal{K} \times \mathcal{K}} c(\kappa_1, \kappa_2) \gamma (d \kappa_1, d \kappa_2)
\end{align*}
$$

ã“ã®å¼ã¯ **æœ€é©è¼¸é€è·é›¢** ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã§ã€

- $c: \mathcal{K} \times \mathcal{K} \to \R$ ã¯**ä¸ãˆã‚‰ã‚ŒãŸ**ã‚³ã‚¹ãƒˆé–¢æ•°
- $\mu_1$ ã¨ $\mu_2$ ã¯ $\mathcal{K}$ ä¸Šã®ç¢ºç‡æ¸¬åº¦
- $\prod (\mu_1, \mu_2)$ ã¯ $\mathcal{K} \times \mathcal{K}$ ä¸Šã®åŒæ™‚ç¢ºç‡åˆ†å¸ƒã§ã‚ã£ã¦ã€$\mu_1$ ã¨ $\mu_2$ ã‚’å‘¨è¾ºç¢ºç‡åˆ†å¸ƒã¨ã—ã¦æŒã¤ã‚ˆã†ãªã‚‚ã®ã®é›†åˆ

ã¨ã„ã†ã“ã¨ã‚‰ã—ã„ã€‚$c$ ã¨ã—ã¦é‡è¦ãªã®ã¯ $\mathcal{K}$ ä¸Šã®è·é›¢ $d_{\mathcal{K}}(\cdot, \cdot)$ ã®æ™‚ãªã©ã‚‰ã—ã„ã€‚ã¾ã£ãŸããƒ”ãƒ³ã¨æ¥ãªã„ã€‚æ›´ã«å¼•ç”¨æ–‡çŒ®ã¨ã—ã¦ã€CÃ©dric Villani ã®ã€ŒOptimal transport, old and newã€ãŒã‚ãŒã£ã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯ã¨ã¦ã‚‚åˆ†åšã„ã®ã§ãƒšãƒ¼ã‚¸æ•°ã ã‘ã§å¿ƒãŒæŠ˜ã‚ŒãŸã€‚

å¼•ãç¶šãæ¤œç´¢ã™ã‚‹ã¨ Yossi Rubner et al. ã® [The Earth Mover's Distance as a Metric for Image Retrieval](https://link.springer.com/article/10.1023/A:1026543900054) ãŒè¦‹ã¤ã‹ã£ãŸã€‚p.8 ã®å†…å®¹ãŒæã‚‰ãè©²å½“ã™ã‚‹ã®ã ãŒã€ä»Šåº¦ã¯ **å‘¨è¾ºåˆ†å¸ƒã®ä»£ã‚ã‚Šã«ä¸ç­‰å¼åˆ¶ç´„ãŒå‡ºã¦ããŸ** ã®ã§ã¾ã™ã¾ã™åˆ†ã‹ã‚‰ãªããªã£ãŸã€‚

ç¶šã‘ã¦ä½ä¹…ç”° ç¥å­æ°ã‚‰ã® [Earth Moverâ€™s Distanceã‚’ç”¨ã„ãŸç”»åƒã®å°è±¡æ¨å®š](https://www.jstage.jst.go.jp/article/jjske/19/1/19_TJSKE-D-19-00038/_article/-char/ja) ã‚’è¦‹ã¤ã‘ãŸã€‚æ—¥æœ¬èªãªã®ã§å„ªã—ã„æ°—ãŒã™ã‚‹ã€‚ã€Œå›³3 EMD ã«ã‚ˆã‚‹è‰²ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ é–“è·é›¢ã®è¨ˆç®—ã€ãŒä½•ã‹ãã‚Œã£ã½ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã‚ã‚‹ã€‚ **ã‚½ãƒ¼ã‚¹ã®åˆ†å¸ƒã‚’ã‚ˆã‚Šåˆ†ã‘ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®åˆ†å¸ƒã«æŒã¡è¾¼ã‚€ã‚ˆã†ã ã€‚ã§ã‚‚ãã®ãƒãƒƒãƒ—ã«ã¤ã„ã¦é™½ã«æ›¸ã„ãŸè«–æ–‡ãŒãªã‹ã£ãŸãŒï¼Ÿ** ã¨ã„ã†ã¨ã“ã‚ã§è¡Œãè©°ã¾ã£ãŸã€‚

ã¨ã„ã†ã“ã¨ã§å®Œå…¨ã«ã™ã£ã‹ã‚Šå¿ƒãŒæŠ˜ã‚ŒãŸã®ã§ã‚‚ã†å¿˜ã‚Œã‚ˆã†ã¨æ€ã£ãŸãŒã€ä»Šæ—¥ã¯æ—¥æ›œæ—¥ãªã®ã§ NumPy ã§é©å½“ã«ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ãŸã€‚

# ä¸€ç•ªç°¡å˜ãªã‚±ãƒ¼ã‚¹

[æœ€é©è¼¸é€å…¥é–€](https://speakerdeck.com/joisino/zui-shi-shu-song-ru-men) ã® p.13 ã‚’å†åº¦è¦‹ã‚‹ã¨ã€åŒã˜é«˜ã•ã®æ£’ã‚°ãƒ©ãƒ•ã‚’å¹³è¡Œç§»å‹•ã—ã¦ã„ã‚‹å›³ãŒã‚ã‚‹ã€‚è¿‘ã„ç§»å‹•ã»ã©æœ€é©è¼¸é€è·é›¢ã¯çŸ­ã„ã“ã¨ã‚’è¨€ã£ã¦ã„ãã†ã ã€‚ãã—ã¦ã“ã®æ£’ãŒ 1 ç‚¹ã«å‡é›†ã—ãŸãƒ‡ãƒ«ã‚¿å‡½æ•°ã®å ´åˆã«ã¯ã‚µãƒãƒ¼ãƒˆã§ã‚ã‚‹ãã® 1 ç‚¹åŒå£«ã®è·é›¢ãŒæœ€é©è¼¸é€è·é›¢ã ã€ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã ã€‚

ãã“ã§ã€ã¾ãšã¯ä»¥ä¸‹ã®ã‚ˆã†ã« $\mathcal{K} = \{ 0, 1, 2, 3, 4 \}$ ã¨ã—ã¦ã€æ“¬ä¼¼çš„ã« $\delta_0 (x)$ ã¨ $\delta_3 (x)$ ã‚’ç”¨æ„ã—ã¦è€ƒãˆãŸã„ã€‚ãŸã¶ã‚“æœ€é©è¼¸é€è·é›¢ã¯ $0$ ã‹ã‚‰ $3$ ã¸ã®ç§»å‹•ã§ã‚ã‚‹ 3 ã¨ãªã‚‹ã®ã ã‚ã†ã€‚

![](/images/dwd-optimal-transport01/001.png)

ãã—ã¦çµè«–ã¨ã—ã¦ã‚ã‚‹æœ€é©åŒ–ã‚’å®Ÿè¡Œã—ãŸçµæœã€â€œæœ€é©è¼¸é€â€ ã‚’å®Ÿç¾ã™ã‚‹è¨ˆç®—ãŒè¦‹ã¤ã‹ã£ã¦ã€è¿‘ä¼¼çš„ã«æ±‚ã‚ãŸæœ€é©è¼¸é€è·é›¢ã¯ 2.764 ã¨ãªã£ãŸã€‚ã“ã®è·é›¢ã‚’å®Ÿç¾ã™ã‚‹è¨ˆç®—å¼ã‹ã‚‰å†æ§‹æˆã—ãŸå‘¨è¾ºåˆ†å¸ƒã¯ä»¥ä¸‹ã§ã‚ã‚Šã€ã¾ãã¾ãå…ƒã® $\mu_1$ ã¨ $\mu_2$ ã‚’ç¶­æŒã—ã¦ã„ã‚‹ã€‚

![](/images/dwd-optimal-transport01/002.png)

æœ€é©è¼¸é€ã‚’å®Ÿç¾ã™ã‚‹ â€œé·ç§»â€ ã¯è¿‘ä¼¼çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã€

$$
\begin{align*}
\hat{T} = \begin{bmatrix}
0.034 & 0 & 0 & 0 & 0 \\
0.009 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 \\
0.914 & 0 & 0.007 & 0.032 & 0.007 \\
0 & 0 & 0 & 0 & 0
\end{bmatrix}
\end{align*}
$$

$\hat{T}$ ã®åˆ—ã”ã¨ã«è¡Œã®è¦ç´ ã‚’è¶³ã—åˆã‚ã›ã‚‹ã¨æ¦‚ã­ $[1 \quad 0 \quad 0 \quad 0 \quad 0]$ ã¨ãªã‚Šã€$\mu_1$ ã«å¯¾å¿œã™ã‚‹ã€‚æ¬¡ã«ã€è¡Œã”ã¨ã«åˆ—ã®è¦ç´ ã‚’è¶³ã—åˆã‚ã›ã‚‹ã¨æ¦‚ã­ $[0 \quad 0 \quad 0 \quad 1 \quad 0]$ ã¨ãªã‚Š $\mu_2$ ã«å¯¾å¿œã™ã‚‹ã€‚

ã¤ã¾ã‚Šã€åˆ—ç•ªå· 0 ã«ã„ãŸç¢ºç‡ 1 ãŒè¡Œç•ªå· 0, 1, 3 ã«ãã‚Œãã‚Œ 0.034, 0.009, 0.914 ã§åˆ†é…ã•ã‚ŒãŸã“ã¨ã‚’æ„å‘³ã—ã¦ã„ã‚‹ã€‚ä»–ã®ã‚‚ã®ã¯èª¤å·®ã§ã‚ã‚‹ã€‚ã‚ˆã£ã¦ã€ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯æœ€é©è¼¸é€è·é›¢ã¯ $0.034 \times |0 - 0| + 0.009 \times |1 - 0| + 0.914 \times |3 - 0| = 2.751$ ã§ã€èª¤å·®ã‚‚ã™ã¹ã¦å«ã‚ã‚‹ã¨ 2.764 ã¨ãªã‚‹ã€‚

ãªãŠã€çœŸã®é·ç§»ã¯

$$
\begin{align*}
T = \begin{bmatrix}
0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 \\
1 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0
\end{bmatrix}
\end{align*}
$$

ã§ã€çœŸã®æœ€é©è¼¸é€è·é›¢ã¯ 3 ã§ã‚ã‚‹ã€‚

ãƒ»ãƒ»ãƒ»ã¨ã„ã†ã“ã¨ãŒæœ€çµ‚çš„ã«åˆ†ã‹ã£ãŸã€‚ã“ã‚Œã¯ã‚‚ã†å°‘ã—ä¸€èˆ¬çš„ãªè¨­å®šã§ã®å®Ÿé¨“çµæœã§æ„Ÿè§¦ã‚’ç¢ºã‹ã‚ãŸå¾Œã«å¾—ã‚‰ã‚ŒãŸå¸°çµã§ã‚ã‚‹ãŒã€ã“ã®æ˜å¿«ãªçµæœæ•…ã«å®Ÿé¨“ã¯é–“é•ã£ã¦ã„ãªã‹ã‚ã†ã¨ã„ã†è‡ªä¿¡ã«ã¤ãªãŒã£ãŸã€‚

# å®Ÿé¨“

ä¸Šè¨˜ã‚’å¾—ãŸå®Ÿé¨“ã®æµã‚Œã‚’ä»¥ä¸‹ã«è¨˜è¿°ã—ã¦ã„ããŸã„ã€‚

ã¾ãšå¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ import ã™ã‚‹:

```python
import numpy as np
import pprint
import matplotlib.pyplot as plt
from matplotlib.ticker import MaxNLocator, MultipleLocator
```

ç´ æœ´ãªç™ºæƒ³ã¯ä»¥ä¸‹ã§ã‚ã£ãŸ:

```python
np.random.seed(seed=42)

N = 5  # ç©ºé–“ K ã‚’é›¢æ•£çš„ã«è€ƒãˆãŸæ™‚ã®å¹…
joint_prob = np.random.rand(N * N).reshape(N, N)  # ä½•ã¨ãªã 2 æ¬¡å…ƒã®ãƒªã‚¹ãƒˆ
```

ã“ã“ã§ã€

- `np.sum(joint_prob, axis=0)` $\approx$ `mu1`
- `np.sum(joint_prob, axis=1)` $\approx$ `mu2`

ãŒè¿‘ã„ã¨è‰¯ã„ã¨æ„Ÿã˜ãŸãŒã€æœªçŸ¥æ•°ãŒ $N^2$ å€‹ã«å¯¾ã—ã€æ–¹ç¨‹å¼ãŒ $2N$ å€‹ãªã®ã§è§£ãŒæ±ºå®šã§ããªã„ã€‚ãã‚Œã§ã‚‚ä½•ã‹å®œã—ãæ±ºã‚ã¦æ¬²ã—ã„ã¨ãªã‚‹ã¨ãƒ»ãƒ»ãƒ»ã¨ã„ã†ã“ã¨ã§ã€Œæœ€é©åŒ–å•é¡Œã€ã®æ„å‘³ãŒåˆ†ã‹ã£ã¦ããŸã€‚

## æœ€é©åŒ–ã—ã¦è¼¸é€ã™ã‚‹ã‚½ãƒ¼ã‚¹ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®åˆ†å¸ƒã‚’æ±ºã‚ã‚‹

é©å½“ãªãƒ‡ãƒ¼ã‚¿ã‚’æ±ºã‚ã¦å•é¡Œè¨­å®šã‚’ã™ã‚‹ã€‚

```python
N = 5
X = np.arange(N, dtype=int)

np.random.seed(seed=42)

# åˆ†å¸ƒ mu1 ã¨ mu2 ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å®šã‚ã‚‹ã€‚å†ç¾æ€§ã®ãŸã‚ã« seed ã¯å›ºå®šã—ã¦ã„ã‚‹ã€‚
mu1 = np.random.rand(N)
mu1 = mu1 / np.sum(mu1)

mu2 = np.random.rand(N)
mu2 = mu2 / np.sum(mu2)

# å¯è¦–åŒ–
fig, axs = plt.subplots(1, 2, figsize=(12, 4))
axs[0].stairs(mu1, fill=True)
axs[0].set_title(r"$\mu_1$")
axs[0].set_xlabel("x")
axs[0].set_ylabel(r"$\mu_1$")
axs[0].xaxis.set_major_locator(MaxNLocator(integer=True))
axs[0].yaxis.set_major_locator(MultipleLocator(0.1)) 
axs[0].set_ylim([0, 1])
axs[0].grid()

axs[1].stairs(mu2, fill=True)
axs[1].set_title(r"$\mu_2$")
axs[1].set_xlabel("x")
axs[1].set_ylabel(r"$\mu_2$")
axs[1].xaxis.set_major_locator(MaxNLocator(integer=True))
axs[1].yaxis.set_major_locator(MultipleLocator(0.1)) 
axs[1].set_ylim([0, 1])
axs[1].grid()

plt.tight_layout()
plt.show()
```

![](/images/dwd-optimal-transport01/003.png)

ã“ã®æ™‚ç‚¹ã§ã¯ã‚ˆãåˆ†ã‹ã‚‰ãªã„ãŒã“ã® 2 ã¤åˆ†å¸ƒã®æœ€é©ãªè¼¸é€ãƒ»ãƒ»ãƒ»ã£ã½ã„ã‚‚ã®ã‚’è¡¨ç¾ã™ã‚‹è¡Œåˆ— `joint_prob` ã‚’æ±‚ã‚ãŸã„ã€‚

## PyTorch ã«ä¹—ã›ã‚‹

`joint_prob` ã‚’æ“ä½œã—ãŸã„ãŒã€å‹¾é…ã‚’ä½¿ã‚ãªã„æœ€é©åŒ–ã®é¡ã§å€¤ã‚’æ±ºå®šã™ã‚‹ã®ã¯ä¸å®‰ãƒ»ãƒ»ãƒ»ã¨è¨€ã†ã‹ä»Šå›ã®å ´åˆã¯ã‚ˆãåˆ†ã‹ã‚‰ãªã„ã®ã§ã€å¾ã€…ã«è‰¯ãã™ã‚‹é›°å›²æ°—ã‚’é‡è¦–ã—ã¦å‹¾é…ã«ã‚ˆã‚‹æœ€é©åŒ–ã‚’ä½¿ã†ã€‚ãã“ã§ PyTorch ã«ä¹—ã›ã‚‹ã“ã¨ã«ã—ãŸã€‚

PyTorch ã‚’ä½¿ã†ãŸã‚ã®è¿½åŠ ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã® import:

```python
import torch
from torch import nn
from torch import optim
```

ä»¥ä¸‹ã€æŸ Quadratic Unconstrained Binary Optimization (QUBO) ã®æ°—æŒã¡ã§åˆ¶ç´„æ¡ä»¶ã‚’æ›¸ãå‡ºã—ãŸã€‚åŒæ™‚ç¢ºç‡åˆ†å¸ƒã§ã‚ã‚‹ã“ã¨ã¨ã€å‘¨è¾ºåˆ†å¸ƒãŒ $\mu_1$ ã¨ $\mu_2$ ã«ãªã‚‹ã“ã¨ã‚’åˆ¶ç´„æ¡ä»¶ã¨ã—ãŸã€‚

ã¾ãšã“ã®åˆ¶ç´„æ¡ä»¶ã‚’æº€ãŸã™ãƒªã‚¹ãƒˆ `joint_prob` ã‚’è¨“ç·´ã§æ±‚ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸ:

```python
# ãƒ©ãƒ³ãƒ€ãƒ ãª 2 æ¬¡å…ƒãƒªã‚¹ãƒˆã‹ã‚‰å§‹ã‚ã‚‹
joint_prob = torch.rand(N * N).reshape(N, N)
# mu1 ã‚’ãƒ†ãƒ³ã‚½ãƒ«ã«ã™ã‚‹
mu1_tensor = torch.tensor(mu1)
# mu2 ã‚’ãƒ†ãƒ³ã‚½ãƒ«ã«ã™ã‚‹
mu2_tensor = torch.tensor(mu2)

# joint_prob ã‚’è¨“ç·´ã™ã‚‹
params = nn.parameter.Parameter(joint_prob, requires_grad=True)
optimizer = optim.Adam([params])

for epoch in range(5000):
    optimizer.zero_grad()

    # joint_prob ã¯ãã‚Œè‡ªèº«ç¢ºç‡åˆ†å¸ƒãªã®ã§ã€ã™ã¹ã¦ã‚’è¶³ã™ã¨ 1 ã§ã‚ã‚‹ã€‚
    prob_constraint = (torch.sum(params) - 1) ** 2
    # è¡Œã«é–¢ã—ã¦è¶³ã—åˆã‚ã›ã¦å¾—ãŸå‘¨è¾ºåˆ†å¸ƒãŒ mu1 ã«ãªã‚‹ã€‚
    mu1_constraint = torch.sum((torch.sum(params, dim=0) - mu1_tensor) ** 2) / N
    # åˆ—ã«é–¢ã—ã¦è¶³ã—åˆã‚ã›ã¦å¾—ãŸå‘¨è¾ºåˆ†å¸ƒãŒ mu2 ã«ãªã‚‹ã€‚
    mu2_constraint = torch.sum((torch.sum(params, dim=1) - mu2_tensor) ** 2) / N
    constraint = prob_constraint + mu1_constraint + mu2_constraint
    loss = constraint
    loss.backward()
    optimizer.step()

    # ç¢ºç‡åˆ†å¸ƒãªã®ã§ã€å€¤ã®ç¯„å›²ã¯ [0, 1] ã§ã‚ã‚Šã€ã¯ã¿å‡ºãŸã‚‚ã®ã¯ã‚¯ãƒªãƒƒãƒ—ã™ã‚‹ã€‚
    with torch.no_grad():
        params.clamp_(0, 1)
```

ã“ã‚Œã¯ã¾ãã¾ãã†ã¾ãã„ã£ã¦ã€`params.cpu().detach().numpy()` ã‹ã‚‰å¾—ã‚‹å‘¨è¾ºåˆ†å¸ƒã¯æ¦‚ã­ `mu1` ã¨ `mu2` ã«ä¸€è‡´ã™ã‚‹ã€‚

## æœ€é©è¼¸é€è·é›¢ã‚’æœ€é©åŒ–ã§æ±‚ã‚ã‚‹

æœ€é©åŒ–ãŒå®Œäº†ã—ãŸæ™‚ç‚¹ã§ã€Œã§ã€æœ€é©è¼¸é€è·é›¢ã¨ã¯ï¼Ÿã€ã¨æ€ã£ãŸã®ã§ã€ä¸Šè¨˜ã®åˆ¶ç´„æ¡ä»¶ã ã‘ã§ãªãã€æœ¬æ¥ã®æå¤±é–¢æ•°ãŒå¿…è¦ã§ã‚ã‚‹ã“ã¨ã«æ°—ã¥ã„ãŸã€‚ã‚‚ã†ä¸€åº¦

$$
\begin{align*}
W_c (\mu_1, \mu_2) = \inf_{\gamma \in \prod (\mu_1, \mu_2)} \int_{\mathcal{K} \times \mathcal{K}} c(\kappa_1, \kappa_2) \gamma (d \kappa_1, d \kappa_2)
\end{align*}
$$

ã‚’æ€ã„å‡ºã™ã¨ã€$\gamma$ ã«å¯¾ã—ã¦ã¯ `joint_prob`ã€$\inf_{\gamma \in \prod (\mu_1, \mu_2)}$ ã«å¯¾ã—ã¦ã¯ä¸Šè¨˜ã®æœ€é©åŒ–ãƒ«ãƒ¼ãƒ—ã®å½¢ã§å®Ÿè£…ã—ãŸã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚ã‚ˆã£ã¦æ®‹ã£ã¦ã„ã‚‹ã®ã¯ã€$\int_{\mathcal{K} \times \mathcal{K}} c(\kappa_1, \kappa_2) \gamma (d \kappa_1, d \kappa_2)$ ã§ã‚ã‚‹ã€‚ã“ã®éƒ¨åˆ†ã¯é›¢æ•£çš„ã«æ›¸ãã¨ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ã§ã‚ã‚ã†ã€‚$c$ ã¨ã„ã†ã€Œä¸ãˆã‚‰ã‚ŒãŸã‚³ã‚¹ãƒˆé–¢æ•°ã€ã¯è‡ªåˆ†ã§æ±ºã‚ã‚‹ã—ã‹ãªã•ãã†ãªã®ã§ã€é©å½“ã«ä½ç½®ã®å·®åˆ†ã®çµ¶å¯¾å€¤ã€ã¤ã¾ã‚Š $L^1$ è·é›¢ã¨ã—ãŸã€‚å®Ÿè£…ã—ãªãŒã‚‰

> $c$ ã¨ã—ã¦é‡è¦ãªã®ã¯ $\mathcal{K}$ ä¸Šã®è·é›¢ $d_{\mathcal{K}}(\cdot, \cdot)$ ã®æ™‚ãªã©ã‚‰ã—ã„ã€‚

ã®æ„å‘³ãŒè‡ªå·±è§£æ±ºã—ãŸã€‚

```python
# ã“ã®æå¤±é–¢æ•°ã®å€¤ã®æœ€é©å€¤ãŒæœ€é©è¼¸é€è·é›¢
EM_loss = 0
for col in range(N):
    for row in range(N):
        amount = params[row, col]  # Î³(dÎºâ‚, dÎºâ‚‚)
        dist = abs(row - col)  # c(Îºâ‚, Îºâ‚‚); L1 distance
        EM_loss += dist * amount
```

ã“ã‚Œã‚’æå¤±é–¢æ•°ã¨ã—ã¦å…ˆã»ã©ã®åˆ¶ç´„æ¡ä»¶ã¨çµ„ã¿åˆã‚ã›ã¦ç›®çš„é–¢æ•°ã‚’ä½œã‚Šã€è¨“ç·´ãƒ«ãƒ¼ãƒ—ã‚’å®Œå…¨ãªã‚‚ã®ã¨ã—ãŸã®ãŒä»¥ä¸‹ã§ã‚ã‚‹ã€‚

æœ€é©åŒ–ã‚’é€²ã‚ã¦ã„ãã¨ã€æœ€åˆã¯åˆ¶ç´„æ¡ä»¶ã‚’æº€ãŸã™ã‚ˆã†ã«ã€ã¤ã¾ã‚Šç¢ºç‡åˆ†å¸ƒã§ã‚ã‚‹ã“ã¨ã¨å‘¨è¾ºåˆ†å¸ƒãŒæŒ‡å®šã®ã‚‚ã®ã«ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’å®ˆã£ã¦ãã‚ŒãŸãŒã€é€”ä¸­ã‹ã‚‰åˆ¶ç´„æ¡ä»¶ã‚’ç ´ã£ã¦ã§ã‚‚æå¤±é–¢æ•°ã®å€¤ã‚’ä¸‹ã’ã‚‹ã“ã¨ã§ç›®çš„é–¢æ•°ã®å…¨ä½“å€¤ã‚’ä¸‹ã’ã‚‹ã‚ˆã†ãªå‹•ãã‚’ã—ã ã—ãŸã€‚ã“ã®ãŸã‚ early stopping ã®è€ƒãˆã‚’ç”¨ã„ã¦è¨“ç·´ã‚’æ‰“ã¡åˆ‡ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã€‚

```python
joint_prob = torch.rand(N * N).reshape(N, N)
mu1_tensor = torch.tensor(mu1)
mu2_tensor = torch.tensor(mu2)

params = nn.parameter.Parameter(joint_prob, requires_grad=True)
optimizer = optim.Adam([params])

losses = []
EM_losses = []
constraints = []

best_constraint = 10000
best_constraint_epoch = -1
patience = 20  # early stopping çš„ãªè€ƒãˆ
patience_cnt = 0

for epoch in range(12000):
    optimizer.zero_grad()

    EM_loss = 0
    for col in range(N):
        for row in range(N):
            amount = params[row, col]
            dist = abs(row - col)
            EM_loss += amount * dist
    EM_loss = EM_loss / (N * N)

    prob_constraint = (torch.sum(params) - 1) ** 2
    mu1_constraint = torch.sum((torch.sum(params, dim=0) - mu1_tensor) ** 2) / N
    mu2_constraint = torch.sum((torch.sum(params, dim=1) - mu2_tensor) ** 2) / N
    constraint = prob_constraint + mu1_constraint + mu2_constraint
    loss = EM_loss + 4 * constraint  # æå¤±é–¢æ•°ã¨åˆ¶ç´„æ¡ä»¶ã‚’é©å½“ã«é‡ã¿ã¥ã‘ã¦è¶³ã™
    loss.backward()
    optimizer.step()

    with torch.no_grad():
        params.clamp_(0, 1)

    # early stopping ã®è€ƒãˆã‚’ç”¨ã„ã¦ã€åˆ¶ç´„æ¡ä»¶ãŒç ´ã‚Œã ã—ãŸã‚‰è¨“ç·´ã‚’çµ‚äº†ã™ã‚‹
    if constraint.item() < best_constraint:
        best_constraint = constraint.item()
        best_constraint_epoch = epoch
        patience_cnt = 0
    else:
        patience_cnt += 1
    if patience_cnt >= patience:
        break

    losses.append(loss.item())
    EM_losses.append(EM_loss.item())
    constraints.append(constraint.item())
```

ã“ã‚Œã¯ç´„ 20 ç§’ã§è¨“ç·´ãŒçµ‚äº†ã™ã‚‹ã€‚

# å®Ÿé¨“çµæœã®ç¢ºèª

ã¾ãšã¯æå¤±é–¢æ•°é¡ã®å€¤ã®æ¨ç§»ã‚’å¯è¦–åŒ–ã™ã‚‹ã€‚çµæ§‹å€¤ãŒå°ã•ããªã‚‹ã®ã§ç¸¦æ–¹å‘ã¯å¯¾æ•°ã‚’ã¨ã£ãŸã€‚

```python
fig, axs = plt.subplots(1, 3, figsize=(18, 4))
axs[0].set_yscale("log")
axs[0].plot(losses)
axs[0].set_title("losses")
axs[0].set_xlabel("epoch")
axs[0].set_ylabel("loss")
axs[0].grid()

axs[1].set_yscale("log")
axs[1].plot(EM_losses)
axs[1].set_title("EM_losses")
axs[1].set_xlabel("epoch")
axs[1].set_ylabel("EM_losse")
axs[1].grid()

axs[2].set_yscale("log")
axs[2].plot(constraints)
axs[2].set_title("constraints")
axs[2].set_xlabel("epoch")
axs[2].set_ylabel("constraint")
axs[2].grid()

plt.tight_layout()
plt.show()
```

![](/images/dwd-optimal-transport01/004.png)

å…¨ä½“ã®å€¤ãŒä¸‹ãŒã£ã¦è¡Œã£ã¦ã„ã‚‹ãŒã€å°‘ã—ã ã‘æ—©ãåˆ¶ç´„æ¡ä»¶é …ãŒåæŸã—ã ã—ã¦ã„ã‚‹ã€‚ã“ã®å¾Œå€¤ãŒä¸Šæ˜‡ã—å§‹ã‚ã¦ã—ã¾ã£ãŸã®ã§ã€early stopping ã§æ‰“ã¡åˆ‡ã£ãŸã€‚

## å‘¨è¾ºåˆ†å¸ƒã®ç¢ºèª

æœ€é©åŒ–å¾Œã® `joint_prob` ã¯å‘¨è¾ºåˆ†å¸ƒ $\mu_1$ ã¨ $\mu_2$ ã‚’ã†ã¾ãè¡¨ç¾ã§ãã¦ã„ã‚‹ã§ã‚ã‚ã†ã‹ï¼Ÿ

```python
final_joint_prob = params.cpu().detach().numpy()

fig, axs = plt.subplots(1, 2, figsize=(12, 4))
mu1_ = np.sum(final_joint_prob, axis=0)
axs[0].stairs(mu1_, fill=True)
axs[0].set_title(r"$\mu_1$")
axs[0].set_xlabel("x")
axs[0].set_ylabel(r"$\mu_1$")
axs[0].xaxis.set_major_locator(MaxNLocator(integer=True))
axs[0].yaxis.set_major_locator(MultipleLocator(0.1)) 
axs[0].set_ylim([0, 1])
axs[0].grid()

mu2_ = np.sum(final_joint_prob, axis=1)
axs[1].stairs(mu2_, fill=True)
axs[1].set_title(r"$\mu_2$")
axs[1].set_xlabel("x")
axs[1].set_ylabel(r"$\mu_2$")
axs[1].xaxis.set_major_locator(MaxNLocator(integer=True))
axs[1].yaxis.set_major_locator(MultipleLocator(0.1)) 
axs[1].set_ylim([0, 1])
axs[1].grid()

plt.tight_layout()
plt.show()
```

ç´°ã‹ã„ã¨ã“ã‚ã¯å¤šå°‘ã®ã‚ºãƒ¬ã¯ã‚ã‚‹ãŒæ¦‚ã­ä¼¼ã¦ã„ã‚‹ã§ã‚ã‚ã†ã€‚

![](/images/dwd-optimal-transport01/005.png)

[å‚è€ƒ] æœ€åˆã«è¨­å®šã—ãŸç¢ºç‡åˆ†å¸ƒ:

![](/images/dwd-optimal-transport01/003.png)

## åŒæ™‚ç¢ºç‡åˆ†å¸ƒã§ã‚ã‚‹ã“ã¨

å‘¨è¾ºåˆ†å¸ƒã¯è‰¯ã„ã¨ã—ã¦ã€ãã‚‚ãã‚‚åŒæ™‚ç¢ºç‡åˆ†å¸ƒã¨è¦‹åšã›ã‚‹çŠ¶æ…‹ãªã®ã ã‚ã†ã‹ï¼Ÿ

```python
print(f"{np.sum(final_joint_prob)=}")
```

> np.sum(final_joint_prob)=0.9981522

ã™ã¹ã¦ã‚’è¶³ã—ã¦ 1 ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã¡ã‚ƒã‚“ã¨ç¢ºç‡åˆ†å¸ƒã¨ã—ã¦è¦‹åšã›ãã†ã§ã‚ã‚‹ã€‚

## åŒæ™‚ç¢ºç‡åˆ†å¸ƒã®ä¸­èº«ã¯ï¼Ÿ

`pprint.pprint(final_joint_prob)` ã™ã‚Œã°è‰¯ã„ã®ã ãŒã€å°‘ã—æ•´å½¢ã—ã¦ã¿ã‚ˆã†:

$$
\begin{align*}
T = \begin{bmatrix}
0.092 & 0 & 0 & 0 & 0 \\
0 & 0.055 & 0 & 0 & 0 \\
0.018 & 0.157 & 0.152 & 0.026 & 0 \\
0 & 0.109 & 0.032 & 0.078 & 0.011 \\
0 & 0 & 0.080 & 0.121 & 0.066
\end{bmatrix}
\end{align*}
$$

åˆ—ç•ªå· 0 ã«ã„ãŸé‡ 0.11 ãã‚‰ã„ã®ã‚‚ã®ãŒ 0.092 ãŒè¡Œç•ªå· 0 ã«ã€0.018 ãŒåˆ—ç•ªå· 2 ã«åˆ†æ•£ã—ãŸã‚‰ã—ã„ã€‚ã¡ã‚‡ã£ã¨é›¢ã‚ŒãŸã¨ã“ã‚ã«ç§»å‹•ã—ãŸã®ã¯é©šã„ãŸã€‚ä½†ã—åŸºæœ¬çš„ã«ã¯ã€å¯¾è§’æˆåˆ†è¾ºã‚Šã«å€¤ãŒé›†ä¸­ã—ã¦ã„ã‚‹ã®ã§ã€ã‚ã‚Šã¨è¿‘éš£ã«å€¤ã‚’è¼¸é€ã—ã¦èª¿æ•´ã—ã¦ã„ã‚‹ã‚±ãƒ¼ã‚¹ãŒå¤šãã†ã§ã‚ã‚‹ã€‚åˆ— 3 ã«æ³¨ç›®ã™ã‚‹ã¨ã€0.225 ãã‚‰ã„æŒã£ã¦ã„ãŸé‡ã®ã†ã¡åŠåˆ†ãã‚‰ã„ã® 0.121 ã‚’è¡Œ 4 ã«ç§»å‹•ã•ã›ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã€‚$\mu_2$ ã®å³ç«¯ãŒçµæ§‹é«˜ã„ã®ã«å¯¾ã—ã€$\mu_1$ ã§ã¯å³ç«¯ã¯ä½ã„ã®ã§ã€ãã®å·®åˆ†ã‚’ãŠéš£ã‹ã‚‰ã‚‚ã‚‰ã£ãŸã¨ã„ã†ã“ã¨ã§ã‚ã‚‹ã€‚è¡Œ 3 ã¨ã—ã¦è¶³ã‚Šãªããªã£ãŸåˆ†ã¯åˆ— 1 ã‹ã‚‰è¡Œ 3 ã¸ã®è¼¸é€ã§å¤§éƒ¨åˆ†è£œã£ã¦ã‚‚ã‚‰ã£ãŸã‚ˆã†ã§ã‚ã‚‹ã€‚

ã“ã®é·ç§»è¡Œåˆ—ã‚’è¦‹ã¦ã„ã‚‹ã†ã¡ã«ã€[Earth Moverâ€™s Distanceã‚’ç”¨ã„ãŸç”»åƒã®å°è±¡æ¨å®š](https://www.jstage.jst.go.jp/article/jjske/19/1/19_TJSKE-D-19-00038/_article/-char/ja) ã®ã€Œå›³3 EMD ã«ã‚ˆã‚‹è‰²ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ é–“è·é›¢ã®è¨ˆç®—ã€ã®ãŠæ°—æŒã¡ãŒåˆ†ã‹ã£ã¦ããŸã€‚

## æœ€é©è¼¸é€è·é›¢

è‚å¿ƒã®æœ€é©è¼¸é€è·é›¢ã¯å¹¾ã‚‰ã§ã‚ã‚ã†ã‹ï¼Ÿ

```python
print(f"EM distance={EM_losses[-1] * (N * N)}")
```

ã¨ã„ã†ã“ã¨ã§ã‚ã‚‹ã€‚ä»Šå›ã“ã®å€¤è‡ªä½“ã¯å¤§ã—ã¦æ„å‘³ãŒãªã„ã€‚

> EM distance=0.7671486120671034

[The Earth Mover's Distance as a Metric for Image Retrieval](https://link.springer.com/article/10.1023/A:1026543900054) ã‚„ arXiv:1701.07875 [Wasserstein GAN](https://arxiv.org/abs/1701.07875) ã§ã¯ã“ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ›´ã«æœ€é©åŒ–ã™ã‚‹å½¢ã§ãƒ‹ãƒ¥ãƒ¼ãƒ©ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’æœ€é©åŒ–ã™ã‚‹ã®ã§ã‚ã‚ã†ã€‚ä½†ã—ã€ä»Šå›ã®å®Ÿé¨“ã§è¦‹ãŸã‚ˆã†ã«ã€ãƒŠã‚¤ãƒ¼ãƒ–ã«æœ€é©è¼¸é€è·é›¢ã‚’æ±‚ã‚ã‚‹ã®ã¯çµæ§‹è¨ˆç®—ã‚³ã‚¹ãƒˆãŒå¤§ããã†ã§ã‚ã‚‹ã€‚

ãªãŠã€ã“ã®å®Ÿé¨“ã‚³ãƒ¼ãƒ‰ã‚’

```python
mu1 = np.zeros(N)
mu1[0] = 1

mu2 = np.zeros(N)
mu2[3] = 1
```

ã§è¡Œã£ãŸçµæœãŒå†’é ­ã®ã€Œä¸€ç•ªç°¡å˜ãªã‚±ãƒ¼ã‚¹ã€ã§ã‚ã‚‹ã€‚

# ã¾ã¨ã‚

æœ€é©è¼¸é€ã‚„æœ€é©è¼¸é€è·é›¢ã«ã¤ã„ã¦ã•ã£ã±ã‚Šä½•ã‚‚åˆ†ã‹ã‚‰ãªã„ã¨ã“ã‚ã‹ã‚‰å§‹ã‚ã¦ã€é›°å›²æ°—ã§å®Ÿè£…ã—ã¦ã„ãä¸­ã§ä½•ã¨ãªãæ¦‚è¦ã‚’ã¤ã‹ã‚€ã“ã¨ãŒã§ããŸã‚ˆã†ã«æ€ã†ã€‚ä¸ãˆã‚‰ã‚ŒãŸã€Œè·é›¢ã€å‡½æ•° $c$ ã®ã‚‚ã¨ã§ã€åˆ†å¸ƒ $\mu_1$ ã¨ $\mu_2$ ã‚’åˆã‚ã›ã“ã‚€ãŸã‚ã«ã€Œé‡ã€ã‚’ $\gamma (d \kappa_1, d \kappa_2)$ ã«å¾“ã£ã¦ç§»å‹•ã™ã‚‹ã¨ã—ã¦ã€ã©ã†ã™ã‚Œã°æœ€é©ã§ã‚ã‚‹ã‹ï¼Ÿã‚’å•ã†å•é¡Œã§ã‚ã£ãŸã€‚

å°‘ã—çŠ¶æ³ã‚’æ›¸ãæ›ãˆã¦ã€é‡ 1 ã‚’å‹•ã‹ã™ãŸã‚ã«å¿…è¦ãªåŠ›ãŒ 1 ã¨ã™ã‚‹ã¨ã€ŒåŠ› x è·é›¢ = ä»•äº‹ã€ã‚’æœ€å°åŒ–ã—ãŸã‚‚ã®ãŒæœ€é©è¼¸é€ â€œä»•äº‹â€ ã§ã‚ã‚Šã€è·ç‰©é‹ã³ã«å¿…è¦ãªåŠ´åŠ›ã®æœ€å°å€¤ã¨ã„ã†ã“ã¨ã§ã‚ã‚‹ã€‚
